@{
    ViewBag.Title = "包管理";
}

<div class="jumbotron">
    <table class="table table-hover">
        <thead>
            <tr>
                <th>包名称</th>
                <th>版本</th>
                <th>发布时间</th>
                <th>作者</th>
                <th>大小</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="table-body">
        </tbody>
    </table>
</div>

@section scripts
{
    <script>
        $(function () {
            Reload();
        });

        function Reload() {
            $.get("/nuget/Packages", function (xml) {
                var doc = $(xml);
                var entry = doc.find("feed").find("entry");
                if (entry.length === 0) {
                    $("#table-body").html('<tr><td colspan="6" style="text-align:center">没有包</td></tr>');
                } else {
                    $("#table-body").html('');
                }
                entry.each(function () {
                    var properties = $(this).find("m\\:properties");
                    var id = properties.find("d\\:Id").text();
                    var version = properties.find("d\\:Version").text();
                    var authors = properties.find("d\\:Authors").text();
                    var publish = properties.find("d\\:Published").text();
                    var size = properties.find("d\\:PackageSize").text();

                    var html = "";
                    html += "<tr>";
                    html += "<td>" + id + "</td>";
                    html += "<td>" + version + "</td>";
                    html += "<td>" + publish + "</td>";
                    html += "<td>" + authors + "</td>";
                    html += "<td>" + (parseInt(size) / 1024).toFixed(0) + " KB</td>";
                    html += '<td><button type="button" data-id="' + id + '" data-ver="' + version + '" class="btn btn-danger" onclick="Delete(this)">删除</button></td>';
                    html += "</tr>";
                    $("#table-body").append($(html));
                });
            });
        }

        function Delete(btn) {
            if (confirm("确定要删除该包么？")) {
                var id = $(btn).data("id");
                var ver = $(btn).data("ver");
                $.post("/api/Package/Delete?id=" + id + "&version=" + ver, function (r) {
                    if (r) {
                        alert(r);
                    } else {
                        Reload();
                    }
                });
            }
        }
    </script>
}
